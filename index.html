<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
</head>
<body>

  <script>

  const raidZone = new Phaser.Geom.Rectangle(480, 0, 1440, 1080);
  const startZone = new Phaser.Geom.Circle(960, 720, 100);

  const damageRange = 100;
  const bossMoveInterval = 5000;

  var player;
  var boss;

  var pawns;

  var playerTarget;
  var bossTarget = new Phaser.Math.Vector2();

  var timeText;

  var nextBossMoveTime;

  var mechanicActive;

  const RaidScene = new Phaser.Class({

    Extends: Phaser.Scene,

    initialize: function RaidScene ()
    {
      Phaser.Scene.call(this, { key: 'RaidScene' });
    },

    preload: function () {
      this.load.image('player', 'assets/player.png');
      this.load.image('pawn', 'assets/pawn.png');
      this.load.image('boss', 'assets/forgivencuteness.png');
      this.load.image('moveTarget', 'assets/moveTarget.png');

      this.load.spritesheet('pawnhair1', 'assets/pawnhair1.png', { frameWidth: 48, frameHeight: 36 });
      this.load.spritesheet('pawnhair2', 'assets/pawnhair2.png', { frameWidth: 48, frameHeight: 36 });
      this.load.spritesheet('pawnhair3', 'assets/pawnhair3.png', { frameWidth: 48, frameHeight: 36 });

      this.load.spritesheet('pawnhead1', 'assets/pawnhead1.png', { frameWidth: 48, frameHeight: 28 });

      this.load.spritesheet('pawnbody1', 'assets/pawnbody1.png', { frameWidth: 48, frameHeight: 36 });
      this.load.spritesheet('pawnbody2', 'assets/pawnbody2.png', { frameWidth: 48, frameHeight: 36 });

      this.load.spritesheet('pawnbottom1', 'assets/pawnbottom1.png', { frameWidth: 48, frameHeight: 36 });
      this.load.spritesheet('pawnbottom2', 'assets/pawnbottom2.png', { frameWidth: 48, frameHeight: 36 });
      this.load.spritesheet('pawnbottom3', 'assets/pawnlegs1.png', { frameWidth: 48, frameHeight: 36 });
    },

    create: function () {
      player = this.physics.add.image(960, 720, 'player');
      playerTarget = this.physics.add.image(960, 720, 'playerTarget');

      const defineAnims = () => {
        const rate = 1;
        const repeat = 1;
        this.anims.create({
          key: 'hair1down',
          frames: this.anims.generateFrameNumbers('pawnhair1', { start: 0, end: 0 }),
          frameRate: rate,
          repeat: repeat
        });
        this.anims.create({
          key: 'hair2down',
          frames: this.anims.generateFrameNumbers('pawnhair2', { start: 0, end: 0 }),
          frameRate: rate,
          repeat: repeat
        });
        this.anims.create({
          key: 'hair3down',
          frames: this.anims.generateFrameNumbers('pawnhair3', { start: 0, end: 0 }),
          frameRate: rate,
          repeat: repeat
        });

        this.anims.create({
          key: 'head1down',
          frames: this.anims.generateFrameNumbers('pawnhead1', { start: 0, end: 0 }),
          frameRate: rate,
          repeat: repeat
        });

        this.anims.create({
          key: 'body1down',
          frames: this.anims.generateFrameNumbers('pawnbody1', { start: 0, end: 0 }),
          frameRate: rate,
          repeat: repeat
        });
        this.anims.create({
          key: 'body2down',
          frames: this.anims.generateFrameNumbers('pawnbody2', { start: 0, end: 0 }),
          frameRate: rate,
          repeat: repeat
        });

        this.anims.create({
          key: 'bottom1down',
          frames: this.anims.generateFrameNumbers('pawnbottom1', { start: 0, end: 0 }),
          frameRate: rate,
          repeat: repeat
        });
        this.anims.create({
          key: 'bottom2down',
          frames: this.anims.generateFrameNumbers('pawnbottom2', { start: 0, end: 0 }),
          frameRate: rate,
          repeat: repeat
        });
        this.anims.create({
          key: 'bottom3down',
          frames: this.anims.generateFrameNumbers('pawnlegs1', { start: 0, end: 0 }),
          frameRate: rate,
          repeat: repeat
        });
      }

      const composePawn = (container) => {
        const getRandomIndex = (array) => {
          return Math.floor(Math.random() * array.length);
        }
        // get legs
        const legKeys = ['pawnbottom1', 'pawnbottom2', 'pawnbottom3'];
        const legDownAnims = ['bottom1down', 'bottom2down', 'bottom3down'];
        const legIndex = getRandomIndex(legKeys);
        const legKey = legKeys[legIndex];
        var legSprite = this.add.sprite(0, 54, legKey);
        legSprite._downAnimKey = legDownAnims[legIndex];
        container.add(legSprite)

        // get torso
        const torsoKeys = ['pawnbody1', 'pawnbody2'];
        const torsoDownAnims = ['body1down', 'body2down'];
        const torsoIndex = getRandomIndex(torsoKeys);
        const torsoKey = torsoKeys[torsoIndex];
        torsoSprite = this.add.sprite(0, 18, torsoKey);
        torsoSprite._downAnimKey = torsoDownAnims[torsoIndex];
        container.add(torsoSprite)

        // get head
        const headKey = 'pawnhead1';
        headSprite = this.add.sprite(0, -12, headKey);
        headSprite._downAnimKey = 'head1down';
        container.add(headSprite)

        // get hair
        const hairKeys = ['pawnhair1', 'pawnhair2', 'pawnhair3'];
        const hairDownAnims = ['hair1down', 'hair2down', 'hair3down'];
        const hairIndex = getRandomIndex(hairKeys);
        const hairKey = hairKeys[hairIndex];
        var hairSprite = this.add.sprite(0, 0, hairKey);
        hairSprite._downAnimKey = hairDownAnims[hairIndex];
        container.add(hairSprite)
      }

      pawns = this.physics.add.group();

      var i
      for (i=0; i<8; i++) {
        const pawn = this.add.container();
        this.physics.world.enable(pawn);
        composePawn(pawn);
        pawns.add(pawn);
      }
      this.anims.create({
        key: 'down',
        frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 0 }),
        frameRate: 0,
        repeat: 0
      });

      Phaser.Actions.RandomCircle(pawns.getChildren(), startZone);
      pawns.getChildren().forEach(pawn => {
        pawn.targetLocation = new Phaser.Geom.Point(pawn.x, pawn.y);
        pawn.pawnMoveInterval = Phaser.Math.RND.between(100, 400)
        pawn.nextPawnMoveTime = pawn.pawnMoveInterval;
      }, this);

      boss = this.physics.add.image(960, 200, 'boss')

      this.input.on('pointerdown', function (pointer)
        {
          playerTarget.setPosition(pointer.x, pointer.y);
          this.physics.moveToObject(player, playerTarget, 240);
        }, this
      );

      timeText = this.add.text(10, 10, 'Time: ', { fill: '#00ff00' });
      nextBossMoveTime = 5000;

      mechanicActive = false;
    },

    update: function(gameTime, delta) {
      timeText.setText('Time: ' + gameTime);

      const checkStop = (object, target) => {
        var distance = Phaser.Math.Distance.Between(object.x, object.y, target.x, target.y);
        if (object.body.speed > 0 && distance < 8)
        {
          object.body.reset(target.x, target.y);
        }
      }

      if (gameTime > nextBossMoveTime) {
        nextBossMoveTime = gameTime + bossMoveInterval;
        bossTarget.x = Phaser.Math.RND.between(480, 1440);
        bossTarget.y = Phaser.Math.RND.between(0, 1080);
        this.physics.moveToObject(boss, bossTarget, 240);
      }

      const movePawn = (pawn) => {
        if (true) { // direction checker later
          // const components = pawn.getAll('_downAnimKey');
          // components.forEach(component => component.anims.play(component._downAnimKey))
        }
        if (gameTime > pawn.nextPawnMoveTime) {
          pawn.nextPawnMoveTime = gameTime + pawn.pawnMoveInterval;
          if (mechanicActive) {
          console.log("Unreachable code, something has gone wrong");
          } else {
            const bossDamageCircle = new Phaser.Geom.Circle(boss.x, boss.y, damageRange);
            if (!bossDamageCircle.contains(pawn.x, pawn.y)) {
              pawn.targetLocation = Phaser.Geom.Circle.Random(bossDamageCircle);
              this.physics.moveToObject(pawn, pawn.targetLocation, 240);
            }
          }
        }
        checkStop(pawn, pawn.targetLocation);
      }

      pawns.getChildren().forEach(pawn => {
        movePawn(pawn);
      }, this);

      checkStop(boss, bossTarget);
      checkStop(player, playerTarget);
    }
  });

  var config = {
      type: Phaser.AUTO,
      width: 1920,
      height: 1080,
      physics: {
          default: 'arcade',
          arcade: {
              gravity: { y: 0 },
              debug: true
          }
      },
      scene: [RaidScene]
  };

  var game = new Phaser.Game(config);

  </script>

</body>
</html>
